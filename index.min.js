b4w.register("b4w_express",function(g,d){function k(c,b){b?(a.preloader.create_preloader(),c.oncontextmenu=function(a){a.preventDefault();a.stopPropagation();return!1},a.data.load(l+"b4w_express.json",m,n)):console.log("b4w init failure")}function n(c){a.preloader.update_preloader(c)}function m(c,b){if(b){a.app.enable_camera_controls();var e=new p,f=new q(e.next_section.bind(e));f.set_position(1,.39);f.set_speed(0);g.train=f;g.switch_railway_section=e.switch_section.bind(e)}else console.log("b4w load failure")}
function p(){function a(a,b){var f=0;this.switch_section=function(){f=(f+1)%b.length};this.get_next_section=function(c){return c==a?b[f]:a}}var b=[new a(0,[1,2]),new a(0,[1,2])],e=[[b[0],b[1]],[b[1],b[0]],[b[1],b[0]]];this.next_section=function(a,b){return e[a][0<b?1:0].get_next_section(a)};this.switch_section=function(){b[0].switch_section();b[1].switch_section()}}function q(c){this.speed=0;var b=a.scenes.get_object_by_name("loco.armature"),e=a.scenes.get_object_by_name("loco.wheel.speaker");this.blow_horn=
function(){var b=a.scenes.get_object_by_name("loco.horn.speaker");a.sfx.is_playing(b)||a.sfx.play(b)};this.accelerate_to=function(b){this.speed!=b&&(this.accelerate_animation_id&&(a.time.clear_animation(this.accelerate_animation_id),this.accelerate_animation_id=void 0),this.accelerate_animation_id=a.time.animate(this.speed,b,500*Math.abs(this.speed-b),this.set_speed.bind(this)))};this.stop=function(){this.accelerate_to(0)};this.set_position=function(c,e){a.anim.apply(b,"path.section."+c,a.anim.SLOT_0);
0!=this.speed&&(a.anim.set_speed(b,this.speed,a.anim.SLOT_0),a.anim.play(b,this.on_railway_section_ends.bind(this),a.anim.SLOT_0));a.anim.set_frame(b,Math.floor(a.anim.get_anim_length(b,a.anim.SLOT_0)*e+1),a.anim.SLOT_0)};this.on_railway_section_ends=function(b,e){var d=a.anim.get_current_anim_name(b,e);d.startsWith("path.section.")&&(d=parseInt(d.slice(13)),d=c(d,this.speed),this.set_position(d,0<=this.speed?0:1))};this.set_speed=function(c){this.speed=c;0==this.speed?(a.anim.is_play(b)&&(a.anim.stop(b,
a.anim.SLOT_ALL),a.sfx.stop(e)),a.scenes.set_wind_params({wind_strength:0})):(a.anim.set_speed(b,this.speed,a.anim.SLOT_ALL),a.sfx.playrate(e,Math.max(.8,1+Math.log(Math.abs(this.speed)))),a.scenes.set_wind_params({wind_strength:.05*this.speed}),a.anim.is_play(b)||(a.anim.play(b,null,a.anim.SLOT_ALL),a.anim.play(b,this.on_railway_section_ends.bind(this),a.anim.SLOT_0),a.sfx.play(e)))};a.anim.apply(b,"path.section.1",a.anim.SLOT_0);a.anim.set_behavior(b,a.anim.AB_FINISH_STOP,a.anim.SLOT_0);a.anim.apply(b,
"loco.wheel.action",a.anim.SLOT_1);a.anim.set_behavior(b,a.anim.AB_CYCLIC,a.anim.SLOT_1)}var a={app:d("app"),config:d("config"),version:d("version"),data:d("data"),scenes:d("scenes"),anim:d("animation"),sfx:d("sfx"),time:d("time"),preloader:d("preloader"),cam:b4w.require("camera"),ctr:b4w.require("constraints"),vec3:b4w.require("vec3"),quat:b4w.require("quat"),trans:b4w.require("transform")},h="DEBUG"==a.version.type(),l=a.config.get_assets_path("b4w_express");g.init=function(){a.app.init({canvas_container_id:"b4w_express_canvas",
callback:k,show_fps:h,console_verbose:h,autoresize:!0})};g.switch_view=function(){var c=a.scenes.get_active_camera();a.ctr.remove(c);switch(this.view){case "train":this.view="main";a.cam.target_setup(c,{pos:a.trans.get_translation(a.scenes.get_object_by_name("position.camera.main")),pivot:new Float32Array([0,-88,0]),use_panning:!0});break;case "follow":this.view="train";a.cam.static_setup(c);a.ctr.append_stiff(c,a.scenes.get_object_by_name("loco.armature"),new Float32Array([-9.0136795,-5.4297924,
3.0844262]),a.quat.fromValues(.5750986,-.3804992,-.3996153,.603978));break;default:this.view="follow",a.cam.static_setup(c),a.ctr.append_stiff(c,a.scenes.get_object_by_name("loco.armature"),new Float32Array([14.9537058,-8.2358027,7.0147314]),a.quat.fromValues(.5148795,.2886761,.3947535,.7040845))}}});var b4w_express=b4w.require("b4w_express");b4w_express.init();
